<project name="platform">
	<import file="common-tasks.xml" />

	<target name="init">
		<subant target="make" buildpath="${source.base}/Infrastructure/CustomBuildTasks" />
	</target>

	<target name="init-nexus-credentials" depends="init,define-customtasks">
		<property file="${user.home}/.pearsonNexusCredentials" />
		<fail unless="nexus.username" message="You must declare nexus.username via -D or in ${user.home}/.pearsonNexusCredentials" />
		<fail unless="nexus.password" message="You must declare nexus.password via -D or in ${user.home}/.pearsonNexusCredentials" />
		<echo>Using Nexus credentials with username ${nexus.username}</echo>
	</target>

	<target name="download-jars" depends="init-nexus-credentials">
		<taskdef classname="com.tle.ant.dependencies.DownloadJars" name="downloadJars" classpathref="customtasks.classpath" />
		<delete>
			<fileset dir="${external.jardir}">
				<include name="*.jar" />
				<include name="*.zip" />
				<include name="lib-src/*" />
			</fileset>
		</delete>
		<downloadJars createJpf="true" createClasspath="true" destDir="${external.jardir}" sourcesDir="${external.jardir}/lib-src">
			<repository id="all-deps" url="https://devops-tools.pearson.com/nexus-deps/service/local/repo_groups/all-deps/content/" username="${nexus.username}" password="${nexus.password}" />
			<repository id="thirdparty" url="https://devops-tools.pearson.com/nexus-deps/content/repositories/thirdparty/" username="${nexus.username}" password="${nexus.password}" />
			<fileset file="${external.jardir}/deps.txt" />
		</downloadJars>
	</target>

	<target name="jpftasks" depends="define-customtasks">
		<condition property="threadpool" value="${use.threadpool}" else="true">
			<isset property="use.threadpool" />
		</condition>
		<condition property="threadcount" value="${use.threadcount}" else="0">
			<isset property="use.threadcount" />
		</condition>
		<typedef classname="com.tle.ant.ParallelBuildTask" name="parBuild" classpathref="customtasks.classpath" />
	</target>

	<fileset id="plugin.manifests" dir="${source.base}">
		<include name="Plugins/*/plugin-jpf.xml" />
		<include name="${external.resource}/*.jar" />
	</fileset>

	<target name="buildorder" depends="jpftasks">
		<jpfClasspath cache="${jpf.cache}" generateOnly="true">
			<fileset refid="plugin.manifests" />
		</jpfClasspath>
	</target>

	<target name="compile" depends="buildorder">
		<parBuild targets="compile" threadcount="${threadcount}" threadpool="${threadpool}">
			<fileset refid="plugin.manifests" />
		</parBuild>
	</target>

	<target name="clean" depends="buildorder">
		<parBuild targets="clean" threadcount="${threadcount}" threadpool="${threadpool}">
			<fileset refid="plugin.manifests" />
		</parBuild>
	</target>

	<target name="make" depends="buildorder">
		<parBuild targets="make" threadcount="${threadcount}" threadpool="${threadpool}">
			<fileset refid="plugin.manifests" />
		</parBuild>
	</target>

	<target name="product" depends="download-jars, buildorder">
		<parBuild targets="product" threadcount="${threadcount}" threadpool="${threadpool}">
			<fileset refid="plugin.manifests" />
		</parBuild>
	</target>
</project>